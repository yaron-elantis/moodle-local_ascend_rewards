define("local_ascend_rewards/store_section",["exports","core/ajax","core/notification","local_ascend_rewards/avatar_modals"],(function(_exports,_ajax,_notification,_avatar_modals){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);const PET_VIDEO_MAP={100:"lynx.mp4",101:"tortoise.mp4",102:"hamster.mp4",103:"falcon.mp4",104:"gryphon.mp4",105:"boar.mp4",106:"viper.mp4",107:"swan.mp4",108:"mischiefcap.mp4",109:"otter.mp4",110:"kinkajou.mp4",111:"seahorse.mp4",112:"dragonet.mp4",113:"mastiff.mp4",114:"raven.mp4",115:"tiger.mp4",116:"wolf.mp4",117:"polar_bear.mp4"},VILLAIN_VIDEO_MAP={elf_dryad:"elf_dryad.mp4",ent_blightmind:"ent_blightmind.mp4",jester_mourner:"jester_mourner.mp4",magician_spellbreaker:"magician_spellbreaker.mp4",nomad_dune:"nomad_dune.mp4",philosopher_mirror:"philosopher_mirror.mp4",mermaid_duchess:"mermaid_duchess.mp4",warrior_warlord:"warrior_warlord.mp4",sorceress_stormveil:"sorceress_stormveil.mp4",gatekeeper_wraith:"gatekeeper_wraith.mp4",viking_betrayer:"viking_betrayer.mp4",pirate_barron:"pirate_barron.mp4",amazon_huntsmistress:"amazon_huntsmistress.mp4",imp_mole:"imp_mole.mp4",wizard_pale_scholar:"wizard_pale_scholar.mp4",maori_shaman:"maori_shaman.mp4",zulu_witchdoctor:"zulu_witchdoctor.mp4",sentinel_void:"sentinel_void.mp4",kapu_judge:"kapu_judge.mp4"};let ajaxRequestFailed="";const callAjax=(methodname,args)=>{const requests=_ajax.default.call([{methodname:methodname,args:args}]);return requests&&requests[0]?requests[0]:Promise.reject(new Error(ajaxRequestFailed||""))},showAlert=function(strings,message){let isError=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!message)return;const title=isError?strings.errorTitle:strings.alertTitle;_notification.default.alert(title||"",message,strings.closeLabel||"")},initStorePurchases=strings=>{document.querySelectorAll(".store-buy-btn:not(.pet-buy-btn):not(.villain-buy-btn)").forEach((btn=>{btn.addEventListener("click",(async()=>{const itemId=btn.getAttribute("data-item-id"),itemName=btn.getAttribute("data-item-name"),itemPrice=btn.getAttribute("data-item-price"),confirmMessage="".concat(strings.purchaseConfirmPrefix).concat(itemName).concat(strings.purchaseConfirmMid).concat(itemPrice).concat(strings.purchaseConfirmSuffix),confirmed=await(async(strings,message,triggerElement)=>{if(!message)return!1;if("function"==typeof _notification.default.saveCancelPromise)try{return await _notification.default.saveCancelPromise(strings.confirmTitle||strings.alertTitle||"",message,strings.purchaseConfirmActionLabel||strings.confirmActionLabel||"",{triggerElement:triggerElement}),!0}catch(error){return!1}return window.confirm(message)})(strings,confirmMessage,btn);confirmed&&(btn.disabled=!0,btn.textContent=strings.processingLabel,callAjax("local_ascend_rewards_store_purchase",{item_id:parseInt(itemId,10)}).then((result=>{if(result&&result.success)return showAlert(strings,"".concat(strings.purchaseSuccessLabel,"\n\n").concat(strings.remainingBalanceLabel," ").concat(result.remaining_coins.toLocaleString()," ").concat(strings.coinsLabel)),void window.location.reload();showAlert(strings,"".concat(strings.errorPrefix||"").concat(result&&result.error||strings.purchaseErrorLabel),!0),btn.disabled=!1,btn.textContent="".concat(strings.purchaseButtonPrefix).concat(itemPrice," ").concat(strings.coinsLabel)})).catch((()=>{showAlert(strings,strings.purchaseProcessingErrorLabel,!0),btn.disabled=!1,btn.textContent="".concat(strings.purchaseButtonPrefix).concat(itemPrice," ").concat(strings.coinsLabel)})))}))}))};_exports.init=config=>{if(!document.querySelector("#a_store"))return;const tokensAvailable=Number(config&&config.tokensAvailable||0),coinBalance=Number(config&&config.coinBalance||0),strings=config&&config.strings||{},urls=config&&config.urls||{},modalStrings=config&&config.modalStrings||{};(0,_avatar_modals.init)({strings:modalStrings}),ajaxRequestFailed=strings.ajaxRequestFailed||"",(strings=>{const timerEl=document.getElementById("xpMultiplierTimer_store");if(!timerEl)return;const updateTimer=()=>{const remaining=parseInt(timerEl.getAttribute("data-expires")||"0",10)-Math.floor(Date.now()/1e3);if(remaining<=0)return void(timerEl.textContent=strings.expiredLabel);const hours=Math.floor(remaining/3600),minutes=Math.floor(remaining%3600/60),seconds=remaining%60;timerEl.textContent="".concat(hours,"h ").concat(minutes,"m ").concat(seconds,"s")};updateTimer(),setInterval(updateTimer,1e3)})(strings),initStorePurchases(strings),(strings=>{document.querySelectorAll(".store-activate-btn").forEach((btn=>{btn.addEventListener("click",(()=>{const itemId=parseInt(btn.getAttribute("data-item-id")||"0",10);btn.disabled=!0,btn.textContent=strings.processingLabel,callAjax("local_ascend_rewards_store_activate",{item_id:itemId}).then((result=>{if(result&&result.success)return showAlert(strings,result.message),void window.location.reload();showAlert(strings,"".concat(strings.errorPrefix||"").concat(result&&result.error||strings.activationErrorLabel),!0),btn.disabled=!1,btn.textContent=strings.activateLabel})).catch((()=>{showAlert(strings,strings.activationProcessingErrorLabel,!0),btn.disabled=!1,btn.textContent=strings.activateLabel}))}))}))})(strings),((tokensAvailable,coinBalance,strings)=>{document.querySelectorAll(".pet-buy-btn").forEach((btn=>{btn.addEventListener("click",(()=>{const petId=parseInt(btn.getAttribute("data-item-id")||"0",10),petName=btn.getAttribute("data-item-name"),petPrice=parseInt(btn.getAttribute("data-item-price")||"0",10),petVideo=PET_VIDEO_MAP[petId]||"lynx.mp4";(0,_avatar_modals.showPetUnlockModal)(petId,petName,petPrice,petVideo,tokensAvailable,coinBalance)}))})),document.querySelectorAll(".store-frame-pet").forEach((frame=>{frame.addEventListener("keydown",(e=>{if("Enter"===e.key||" "===e.key){e.preventDefault();const btn=frame.closest(".store-card").querySelector(".pet-buy-btn");btn&&!btn.disabled&&btn.click()}})),frame.addEventListener("click",(()=>{const btn=frame.closest(".store-card").querySelector(".pet-buy-btn");btn&&!btn.disabled&&btn.click()}))}))})(tokensAvailable,coinBalance),((tokensAvailable,coinBalance)=>{document.querySelectorAll(".villain-buy-btn").forEach((btn=>{btn.addEventListener("click",(()=>{const villainId=parseInt(btn.getAttribute("data-item-id")||"0",10),villainName=btn.getAttribute("data-item-name"),villainPrice=parseInt(btn.getAttribute("data-item-price")||"0",10),villainIconName=btn.getAttribute("data-villain-icon")||"",videoKey=villainIconName.replace(".png",""),villainVideo=VILLAIN_VIDEO_MAP[videoKey]||"elf_dryad.mp4";(0,_avatar_modals.showVillainUnlockModal)(villainId,villainName,villainPrice,villainIconName,villainVideo,tokensAvailable,coinBalance)}))})),document.querySelectorAll(".store-frame-villain").forEach((frame=>{frame.addEventListener("keydown",(e=>{if("Enter"===e.key||" "===e.key){e.preventDefault();const btn=frame.closest(".store-card").querySelector(".villain-buy-btn");btn&&!btn.disabled&&btn.click()}})),frame.addEventListener("click",(()=>{const btn=frame.closest(".store-card").querySelector(".villain-buy-btn");btn&&!btn.disabled&&btn.click()}))}))})(tokensAvailable,coinBalance),((strings,urls)=>{const mysteryBtns=document.querySelectorAll(".mysterybox-open-btn"),mysteryModal=document.getElementById("mysteryBoxModal"),boxesContainer=document.getElementById("boxesContainer"),resultDisplay=document.getElementById("resultDisplay"),resultMessage=document.getElementById("resultMessage"),resultIcon=document.getElementById("resultIcon"),closeModalBtn=document.getElementById("closeModalBtn");mysteryBtns.length&&(mysteryBtns.forEach((btn=>{btn.addEventListener("click",(()=>{const price=parseInt(btn.getAttribute("data-price")||"50",10);mysteryModal&&(mysteryModal.style.display="flex",boxesContainer&&(boxesContainer.style.display="none"),resultDisplay&&(resultDisplay.style.display="block")),btn.disabled=!0;const originalText=btn.textContent;btn.textContent=strings.mysteryOpeningLabel,callAjax("local_ascend_rewards_mysterybox_open",{price:price}).then((result=>{if(!result||!result.success){mysteryModal&&(mysteryModal.style.display="none");const message=result&&result.message||strings.mysteryErrorCouldNotOpen;return showAlert(strings,"".concat(strings.errorPrefix||"").concat(message),!0),btn.disabled=!1,void(btn.textContent=originalText)}const cacheBust="?v=".concat(Date.now()),videoUrl={coins:"".concat(urls.videoCoinsUrl).concat(cacheBust),coins_duplicate:"".concat(urls.videoCoinsUrl).concat(cacheBust),tokens:"".concat(urls.videoTokensUrl).concat(cacheBust),avatar_new:"".concat(urls.videoHeroUrl).concat(cacheBust),avatar_duplicate:"".concat(urls.videoHeroUrl).concat(cacheBust),avatar_locked_level:"".concat(urls.videoHeroUrl).concat(cacheBust),nothing:"".concat(urls.videoNoRewardUrl).concat(cacheBust)}[result.reward_type]||"".concat(urls.videoNoRewardUrl).concat(cacheBust);let resultHTML='<video autoplay playsinline preload="auto" crossorigin="anonymous" class="mystery-result-video" id="rewardVideo"><source src="'.concat(videoUrl,'" type="video/mp4"></video>');resultIcon.innerHTML=resultHTML;let messageHTML="",balanceHTML="";if("tokens"===result.reward_type?(messageHTML='<div class="mystery-result-media"><img src="'.concat(urls.imgStarUrl,'" class="mystery-result-icon-image mystery-result-icon-image--star"></div>')+"<div>".concat(result.message,"</div>"),balanceHTML='<div class="mystery-balance">'.concat(strings.newBalanceLabel,' <img src="').concat(urls.imgStarUrl,'" class="mystery-balance-icon mystery-balance-icon--star">').concat(result.total_tokens," ").concat(strings.tokensLabel,"</div>")):"coins"===result.reward_type||"coins_duplicate"===result.reward_type?(messageHTML='<div class="mystery-result-media"><img src="'.concat(urls.imgCoinsUrl,'" class="mystery-result-icon-image mystery-result-icon-image--coins"></div>')+"<div>".concat(result.message,"</div>"),balanceHTML='<div class="mystery-balance">'.concat(strings.newBalanceLabel,' <img src="').concat(urls.imgCoinsUrl,'" class="mystery-balance-icon mystery-balance-icon--coins">').concat(result.new_balance.toLocaleString()," ").concat(strings.coinsLabel,"</div>")):"avatar_duplicate"===result.reward_type||"avatar_locked_level"===result.reward_type?(messageHTML="<div>".concat(result.message,"</div>"),balanceHTML='<div class="mystery-balance">'.concat(strings.newBalanceLabel,' <img src="').concat(urls.imgCoinsUrl,'" class="mystery-balance-icon mystery-balance-icon--coins">').concat(result.new_balance.toLocaleString()," ").concat(strings.coinsLabel,"</div>")):"avatar_new"===result.reward_type?messageHTML="<div>".concat(result.message,"</div>"):(messageHTML=result.message,balanceHTML='<div class="mystery-balance">'.concat(strings.balanceLabel,' <img src="').concat(urls.imgCoinsUrl,'" class="mystery-balance-icon mystery-balance-icon--coins">').concat(result.new_balance.toLocaleString()," ").concat(strings.coinsLabel,"</div>")),resultMessage.innerHTML=messageHTML+balanceHTML,("avatar_new"===result.reward_type||"avatar_duplicate"===result.reward_type)&&result.reward_data&&result.reward_data.avatar_filename){const avatarUrl="".concat(urls.avatarCircularBaseUrl).concat(result.reward_data.avatar_filename);resultHTML+='<div class="mystery-avatar-reward" id="avatarReward"><img src="'.concat(avatarUrl,'" alt="').concat(strings.avatarAltLabel||"",'" class="mystery-avatar-image"></div>'),resultIcon.innerHTML=resultHTML}const video=document.getElementById("rewardVideo");video&&(video.addEventListener("error",(()=>{resultMessage.classList.add("animate-slide-in"),resultMessage.style.opacity="1",closeModalBtn.style.opacity="1";const avatarReward=document.getElementById("avatarReward");if(avatarReward){const avatarImg=avatarReward.querySelector("img");avatarImg&&(avatarImg.classList.add("animate-bounce-in"),avatarImg.style.opacity="1")}})),video.addEventListener("ended",(()=>{resultMessage.classList.add("animate-slide-in"),resultMessage.style.opacity="1",setTimeout((()=>{closeModalBtn.style.opacity="1"}),300);const avatarReward=document.getElementById("avatarReward");if(avatarReward){const avatarImg=avatarReward.querySelector("img");avatarImg&&(avatarImg.classList.add("animate-bounce-in"),avatarImg.style.opacity="1")}})),setTimeout((()=>{if(!resultMessage.style.opacity||"0"===resultMessage.style.opacity){resultMessage.classList.add("animate-slide-in"),resultMessage.style.opacity="1",closeModalBtn.style.opacity="1";const avatarReward=document.getElementById("avatarReward");if(avatarReward){const avatarImg=avatarReward.querySelector("img");avatarImg&&"0"===avatarImg.style.opacity&&(avatarImg.classList.add("animate-bounce-in"),avatarImg.style.opacity="1")}}}),5e3)),btn.disabled=!1,btn.textContent=originalText})).catch((error=>{console.error("Error opening mystery box:",error),boxesContainer&&(boxesContainer.style.display="none"),resultDisplay&&(resultDisplay.style.display="block"),resultIcon.innerHTML='<video autoplay loop playsinline class="mystery-result-video mystery-result-video--fallback"><source src="'.concat(urls.videoNoRewardUrl,'" type="video/mp4"></video>'),resultMessage.textContent=strings.mysteryErrorProcessing,resultMessage.classList.add("animate-slide-in"),resultMessage.style.opacity="1",closeModalBtn&&(closeModalBtn.style.opacity="1"),btn.disabled=!1,btn.textContent=originalText}))}))})),closeModalBtn&&closeModalBtn.addEventListener("click",(()=>{mysteryModal&&(mysteryModal.style.display="none",window.location.reload())})))})(strings,urls)}}));

//# sourceMappingURL=store_section.min.js.map